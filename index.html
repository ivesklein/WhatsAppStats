<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin-bottom: 20px; border-radius: 8px; }
        .upload-area.dragover { border-color: #007bff; background: #f8f9fa; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff; }
        .chart-container { width: 100%; height: 400px; margin: 20px 0; }
        .ranking-list { list-style: none; padding: 0; }
        .ranking-list li { padding: 10px; margin: 5px 0; background: #e9ecef; border-radius: 4px; display: flex; justify-content: space-between; }
        .ranking-list li:nth-child(1) { background: #ffd700; }
        .ranking-list li:nth-child(2) { background: #c0c0c0; }
        .ranking-list li:nth-child(3) { background: #cd7f32; }
        .unregistered { color: #dc3545; font-family: monospace; }
        .tooltip { position: relative; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 300px; background: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -150px; opacity: 0; transition: opacity 0.3s; font-size: 12px; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .show-more { color: #007bff; cursor: pointer; text-decoration: underline; margin-top: 10px; }
        .show-more:hover { color: #0056b3; }
        .message { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; background: #f8f9fa; }
        .message.highlight { background: #fff3cd; border-left-color: #ffc107; }
        .sender { font-weight: bold; color: #007bff; cursor: pointer; }
        .sender:hover { text-decoration: underline; }
        .time { color: #6c757d; font-size: 0.9em; }
        input[type="file"] { margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± WhatsApp Chat Analyzer</h1>
        
        <div class="upload-area" id="uploadArea">
            <p>üìÅ Drop your WhatsApp chat .txt file here or click to select</p>
            <input type="file" id="fileInput" accept=".txt" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()">Select File</button>
            <p style="font-size: 0.9em; color: #6c757d; margin-top: 15px;">üí° How to export: WhatsApp ‚Üí Group ‚Üí 3 dots ‚Üí More ‚Üí Export Chat ‚Üí Without Media ‚Üí Gmail</p>
        </div>

        <div id="results" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üí¨ Chat Messages</h3>
                    <input type="text" id="searchInput" placeholder="Search messages..." style="width: 70%; margin-bottom: 10px; padding: 5px;">
                    <button onclick="findNext()" style="margin-bottom: 10px; margin-left: 5px;">Find Next</button>
                    <button onclick="clearFilter()" style="margin-bottom: 10px; margin-left: 5px;">Show All</button>
                    <div id="searchCount" style="font-size: 0.9em; color: #6c757d;"></div>
                    <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff;"></div>
                </div>
                
                <div class="stat-card">
                    <h3>üèÜ Top Contributors (by words)</h3>
                    <ul class="ranking-list" id="wordRanking"></ul>
                </div>
                
                <div class="stat-card">
                    <h3>üìû Unregistered Numbers</h3>
                    <div id="unregisteredNumbers"></div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>



            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üí¨ Message Statistics</h3>
                    <div id="overview"></div>
                    <div id="messageStats"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const results = document.getElementById('results');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                analyzeChat(content);
            };
            reader.readAsText(file);
        }

        function analyzeChat(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const messages = [];
            const users = {};
            const hourlyActivity = {};
            const dailyActivity = {};
            const unregisteredNumbers = new Set();
            const userMessages = {};

            // Parse messages
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            
            lines.forEach(line => {
                const match = line.match(/^(\d{1,2}\/\d{1,2}\/\d{2,4}),\s(\d{1,2}:\d{2})\s-\s(.+?):\s(.*)$/);
                if (match) {
                    const [, date, time, sender, message] = match;
                    const messageDate = new Date(date);
                    if (messageDate < oneMonthAgo) return;
                    const hour = parseInt(time.split(':')[0]);
                    const words = message.split(' ').filter(w => w.trim() && w !== '<Media' && w !== 'omitted>').length;
                    const formattedDate = messageDate.getFullYear() + '/' + String(messageDate.getMonth() + 1).padStart(2, '0') + '/' + String(messageDate.getDate()).padStart(2, '0');
                    
                    messages.push({ date: formattedDate, time, sender, message, words, hour });
                    
                    if (!users[sender]) {
                        users[sender] = { messages: 0, words: 0, mediaCount: 0 };
                        userMessages[sender] = [];
                    }
                    users[sender].messages++;
                    users[sender].words += words;
                    userMessages[sender].push({ date: formattedDate, time, message });
                    
                    if (message.includes('<Media omitted>')) {
                        users[sender].mediaCount++;
                    }
                    
                    const dayOfWeek = messageDate.getDay();
                    const dayHourKey = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dayOfWeek]} ${hour}:00`;
                    if (!hourlyActivity[dayHourKey]) hourlyActivity[dayHourKey] = 0;
                    hourlyActivity[dayHourKey]++;
                    
                    const dayKey = formattedDate;
                    dailyActivity[dayKey] = (dailyActivity[dayKey] || 0) + 1;
                    
                    // Check for unregistered numbers
                    if (sender.match(/^\+\d+/)) {
                        unregisteredNumbers.add(sender);
                    }
                } else if (line.includes('joined using this group\'s invite link')) {
                    const joinMatch = line.match(/(\+\d+\s\d+\s\d+\s\d+)/);
                    if (joinMatch) {
                        unregisteredNumbers.add(joinMatch[1]);
                    }
                }
            });

            window.allMessages = messages;
            displayResults(messages, users, hourlyActivity, dailyActivity, unregisteredNumbers, userMessages);
        }

        function displayResults(messages, users, hourlyActivity, dailyActivity, unregisteredNumbers, userMessages) {
            results.style.display = 'block';

            // Overview
            document.getElementById('overview').innerHTML = `
                <p><strong>Total Messages:</strong> ${messages.length}</p>
                <p><strong>Total Participants:</strong> ${Object.keys(users).length}</p>
                <p><strong>Date Range:</strong> ${messages[0]?.date} - ${messages[messages.length-1]?.date}</p>
                <p><strong>Total Words:</strong> ${Object.values(users).reduce((sum, u) => sum + u.words, 0)}</p>
            `;

            // Word ranking
            window.allSortedUsers = Object.entries(users).sort(([,a], [,b]) => b.words - a.words);
            window.userMessages = userMessages;
            const topUsers = allSortedUsers.slice(0, 10);
            
            window.renderUserList = function(userList, containerId) {
                document.getElementById(containerId).innerHTML = userList
                    .map(([name, data], index) => {
                        const lastMessages = window.userMessages[name].slice(-3).reverse()
                            .map(m => `${m.date} ${m.time}: ${m.message.substring(0, 50)}${m.message.length > 50 ? '...' : ''}`)
                            .join('<br>');
                        return `<li class="tooltip"><span class="sender" onclick="filterBySender('${name}')">${name}</span><span>${data.words} words (${data.messages} msgs)</span><span class="tooltiptext">${lastMessages}</span></li>`;
                    }).join('') + (userList.length < window.allSortedUsers.length ? `<div class="show-more" onclick="renderUserList(window.allSortedUsers, 'wordRanking')">Show more (${window.allSortedUsers.length - userList.length} remaining)</div>` : '');
            };
            
            renderUserList(topUsers, 'wordRanking');

            // Unregistered numbers sorted by word count
            window.allUnregistered = Array.from(unregisteredNumbers)
                .filter(num => users[num])
                .sort((a, b) => users[b].words - users[a].words);
            window.users = users;
            const topUnregistered = allUnregistered.slice(0, 12);
            
            window.renderUnregisteredList = function(numList, containerId) {
                document.getElementById(containerId).innerHTML = 
                    numList.length > 0 
                        ? numList.map(num => `<div class="unregistered"><span class="sender" onclick="filterBySender('${num}')">${num}</span> (${window.users[num].words} words)</div>`).join('') + 
                          (numList.length < window.allUnregistered.length ? `<div class="show-more" onclick="renderUnregisteredList(window.allUnregistered, 'unregisteredNumbers')">Show more (${window.allUnregistered.length - numList.length} remaining)</div>` : '')
                        : '<p>No unregistered numbers found</p>';
            };
            
            renderUnregisteredList(topUnregistered, 'unregisteredNumbers');

            // Activity chart
            createActivityChart(hourlyActivity);
            
            // Chat messages
            renderChatMessages(messages);
            
            // Search functionality
            window.currentSearchIndex = -1;
            window.searchMatches = [];
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                const messageElements = document.querySelectorAll('.message');
                window.searchMatches = [];
                window.currentSearchIndex = -1;
                
                messageElements.forEach((msg, index) => {
                    const text = msg.textContent.toLowerCase();
                    if (text.includes(query) && query) {
                        msg.classList.add('highlight');
                        window.searchMatches.push(index);
                    } else {
                        msg.classList.remove('highlight');
                    }
                });
                
                if (window.searchMatches.length > 0) {
                    window.currentSearchIndex = 0;
                    messageElements[window.searchMatches[0]].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.getElementById('searchCount').textContent = `1 of ${window.searchMatches.length} matches`;
                } else if (query) {
                    document.getElementById('searchCount').textContent = 'No matches found';
                } else {
                    document.getElementById('searchCount').textContent = '';
                }
            });


            // Message stats
            const mediaMessages = messages.filter(m => m.message.includes('<Media omitted>')).length;
            document.getElementById('messageStats').innerHTML = `
                <p><strong>Text Messages:</strong> ${messages.length - mediaMessages}</p>
                <p><strong>Media Messages:</strong> ${mediaMessages}</p>
                <p><strong>Avg Words/Message:</strong> ${(Object.values(users).reduce((sum, u) => sum + u.words, 0) / messages.length).toFixed(1)}</p>
                <p><strong>Most Active Time:</strong> ${Object.entries(hourlyActivity).reduce((a,b) => hourlyActivity[a[0]] > hourlyActivity[b[0]] ? a : b)[0]}</p>
            `;


        }

        function createActivityChart(hourlyActivity) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            const labels = [];
            const data = [];
            
            const backgroundColors = [];
            const now = new Date();
            const currentDay = now.getDay();
            const currentHour = now.getHours();
            
            // Start from current day and hour, then wrap around
            for(let i = 0; i < 7 * 24; i++) {
                const totalHours = currentDay * 24 + currentHour + 1 + i;
                const dayIndex = Math.floor(totalHours / 24) % 7;
                const hour = totalHours % 24;
                const day = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dayIndex];
                const key = `${day} ${hour}:00`;
                
                labels.push(key);
                data.push(hourlyActivity[key] || 0);
                backgroundColors.push((hour >= 22 || hour <= 6) ? 'rgba(25, 118, 210, 0.8)' : 'rgba(255, 193, 7, 0.8)');
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Messages per Hour',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Messages' }
                        },
                        x: {
                            title: { display: true, text: 'Day and Hour' }
                        }
                    },
                    plugins: {
                        title: { display: true, text: 'Activity Histogram - Messages by Day and Hour (Red = Now)' }
                    }
                }
            });
        }
        
        function renderChatMessages(messages) {
            document.getElementById('chatMessages').innerHTML = messages
                .map(msg => `<div class="message" data-sender="${msg.sender}"><span class="sender" onclick="filterBySender('${msg.sender}')">${msg.sender}</span> <span class="time">${msg.date} ${msg.time}</span><br>${msg.message}</div>`)
                .join('');
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }
        
        function filterBySender(sender) {
            const filtered = window.allMessages.filter(msg => msg.sender === sender);
            renderChatMessages(filtered);
            document.getElementById('searchInput').value = '';
        }
        
        function findNext() {
            if (window.searchMatches.length === 0) return;
            
            window.currentSearchIndex = (window.currentSearchIndex + 1) % window.searchMatches.length;
            const messageElements = document.querySelectorAll('.message');
            messageElements[window.searchMatches[window.currentSearchIndex]].scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('searchCount').textContent = `${window.currentSearchIndex + 1} of ${window.searchMatches.length} matches`;
        }
        
        function clearFilter() {
            renderChatMessages(window.allMessages);
            document.getElementById('searchInput').value = '';
            window.searchMatches = [];
            window.currentSearchIndex = -1;
            document.getElementById('searchCount').textContent = '';
        }


    </script>
</body>
</html>